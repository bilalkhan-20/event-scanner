import { useState, useRef, useCallback, useEffect } from "react";
import jsQR from "jsqr";
import { Camera, Upload, ScanLine, Copy, ExternalLink, X, CheckCircle2, AlertCircle } from "lucide-react";

type ScanMode = "camera" | "upload";
type ScanResult = {
  data: string;
  location: { x: number; y: number; width: number; height: number } | null;
};

const Index = () => {
  const [mode, setMode] = useState<ScanMode>("upload");
  const [result, setResult] = useState<ScanResult | null>(null);
  const [uploadedImage, setUploadedImage] = useState<string | null>(null);
  const [isScanning, setIsScanning] = useState(false);
  const [cameraActive, setCameraActive] = useState(false);
  const [copied, setCopied] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const canvasRef = useRef<HTMLCanvasElement>(null);
  const videoRef = useRef<HTMLVideoElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const streamRef = useRef<MediaStream | null>(null);
  const animFrameRef = useRef<number>(0);
  const imageRef = useRef<HTMLImageElement | null>(null);

  const stopCamera = useCallback(() => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach((t) => t.stop());
      streamRef.current = null;
    }
    cancelAnimationFrame(animFrameRef.current);
    setCameraActive(false);
  }, []);

  const startCamera = useCallback(async () => {
    setResult(null);
    setError(null);
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
      });
      streamRef.current = stream;
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        await videoRef.current.play();
        setCameraActive(true);
        scanCameraFrame();
      }
    } catch {
      setError("Camera access denied. Please allow camera permission.");
    }
  }, []);

  const scanCameraFrame = useCallback(() => {
    const video = videoRef.current;
    const canvas = canvasRef.current;
    if (!video || !canvas || video.readyState !== video.HAVE_ENOUGH_DATA) {
      animFrameRef.current = requestAnimationFrame(scanCameraFrame);
      return;
    }

    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    if (!ctx) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);

    if (code) {
      const loc = code.location;
      const x = Math.min(loc.topLeftCorner.x, loc.bottomLeftCorner.x);
      const y = Math.min(loc.topLeftCorner.y, loc.topRightCorner.y);
      const w = Math.max(loc.topRightCorner.x, loc.bottomRightCorner.x) - x;
      const h = Math.max(loc.bottomLeftCorner.y, loc.bottomRightCorner.y) - y;

      // Draw box on canvas
      ctx.strokeStyle = "hsl(160, 84%, 44%)";
      ctx.lineWidth = 4;
      ctx.strokeRect(x - 8, y - 8, w + 16, h + 16);

      // Corner accents
      const cornerLen = 20;
      ctx.lineWidth = 6;
      // Top-left
      ctx.beginPath(); ctx.moveTo(x - 8, y - 8 + cornerLen); ctx.lineTo(x - 8, y - 8); ctx.lineTo(x - 8 + cornerLen, y - 8); ctx.stroke();
      // Top-right
      ctx.beginPath(); ctx.moveTo(x + w + 8 - cornerLen, y - 8); ctx.lineTo(x + w + 8, y - 8); ctx.lineTo(x + w + 8, y - 8 + cornerLen); ctx.stroke();
      // Bottom-left
      ctx.beginPath(); ctx.moveTo(x - 8, y + h + 8 - cornerLen); ctx.lineTo(x - 8, y + h + 8); ctx.lineTo(x - 8 + cornerLen, y + h + 8); ctx.stroke();
      // Bottom-right
      ctx.beginPath(); ctx.moveTo(x + w + 8 - cornerLen, y + h + 8); ctx.lineTo(x + w + 8, y + h + 8); ctx.lineTo(x + w + 8, y + h + 8 - cornerLen); ctx.stroke();

      setResult({ data: code.data, location: { x, y, width: w, height: h } });
      stopCamera();
      return;
    }

    animFrameRef.current = requestAnimationFrame(scanCameraFrame);
  }, [stopCamera]);

  useEffect(() => {
    return () => {
      stopCamera();
    };
  }, [stopCamera]);

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setResult(null);
    setError(null);

    const reader = new FileReader();
    reader.onload = (ev) => {
      const dataUrl = ev.target?.result as string;
      setUploadedImage(dataUrl);

      const img = new Image();
      img.onload = () => {
        imageRef.current = img;
      };
      img.src = dataUrl;
    };
    reader.readAsDataURL(file);
  };

  const scanUploadedImage = () => {
    const img = imageRef.current;
    const canvas = canvasRef.current;
    if (!img || !canvas) return;

    setIsScanning(true);
    setError(null);

    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    if (!ctx) return;

    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);

    setTimeout(() => {
      if (code) {
        const loc = code.location;
        const x = Math.min(loc.topLeftCorner.x, loc.bottomLeftCorner.x);
        const y = Math.min(loc.topLeftCorner.y, loc.topRightCorner.y);
        const w = Math.max(loc.topRightCorner.x, loc.bottomRightCorner.x) - x;
        const h = Math.max(loc.bottomLeftCorner.y, loc.bottomRightCorner.y) - y;

        // Draw the image again and overlay box
        ctx.drawImage(img, 0, 0);
        ctx.strokeStyle = "hsl(160, 84%, 44%)";
        ctx.lineWidth = Math.max(4, Math.min(img.width, img.height) * 0.008);
        ctx.strokeRect(x - 10, y - 10, w + 20, h + 20);

        const cornerLen = Math.max(15, Math.min(w, h) * 0.15);
        ctx.lineWidth = Math.max(6, Math.min(img.width, img.height) * 0.012);
        ctx.beginPath(); ctx.moveTo(x - 10, y - 10 + cornerLen); ctx.lineTo(x - 10, y - 10); ctx.lineTo(x - 10 + cornerLen, y - 10); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x + w + 10 - cornerLen, y - 10); ctx.lineTo(x + w + 10, y - 10); ctx.lineTo(x + w + 10, y - 10 + cornerLen); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x - 10, y + h + 10 - cornerLen); ctx.lineTo(x - 10, y + h + 10); ctx.lineTo(x - 10 + cornerLen, y + h + 10); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x + w + 10 - cornerLen, y + h + 10); ctx.lineTo(x + w + 10, y + h + 10); ctx.lineTo(x + w + 10, y + h + 10 - cornerLen); ctx.stroke();

        // Semi-transparent overlay outside QR
        ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
        ctx.fillRect(0, 0, canvas.width, y - 10);
        ctx.fillRect(0, y - 10, x - 10, h + 20);
        ctx.fillRect(x + w + 10, y - 10, canvas.width - x - w - 10, h + 20);
        ctx.fillRect(0, y + h + 10, canvas.width, canvas.height - y - h - 10);

        setResult({ data: code.data, location: { x, y, width: w, height: h } });
      } else {
        setError("No QR code found in this image.");
      }
      setIsScanning(false);
    }, 500);
  };

  const copyResult = () => {
    if (result) {
      navigator.clipboard.writeText(result.data);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  const isUrl = (s: string) => {
    try { new URL(s); return true; } catch { return false; }
  };

  const resetAll = () => {
    stopCamera();
    setResult(null);
    setUploadedImage(null);
    setError(null);
    setIsScanning(false);
    imageRef.current = null;
    if (fileInputRef.current) fileInputRef.current.value = "";
    const canvas = canvasRef.current;
    if (canvas) {
      const ctx = canvas.getContext("2d");
      ctx?.clearRect(0, 0, canvas.width, canvas.height);
    }
  };

  const switchMode = (newMode: ScanMode) => {
    resetAll();
    setMode(newMode);
  };

  return (
    <div className="min-h-screen bg-background flex flex-col items-center px-4 py-8">
      {/* Header */}
      <div className="text-center mb-8">
        <div className="inline-flex items-center gap-3 mb-3">
          <div className="w-10 h-10 rounded-lg bg-primary/10 border border-primary/20 flex items-center justify-center">
            <ScanLine className="w-5 h-5 text-primary" />
          </div>
          <h1 className="text-3xl font-bold text-foreground font-mono tracking-tight">
            QR Scanner
          </h1>
        </div>
        <p className="text-muted-foreground text-sm">
          Scan QR codes with your camera or upload an image
        </p>
      </div>

      {/* Mode Toggle */}
      <div className="flex bg-secondary rounded-lg p-1 mb-8 gap-1">
        <button
          onClick={() => switchMode("camera")}
          className={`flex items-center gap-2 px-5 py-2.5 rounded-md text-sm font-medium transition-all ${
            mode === "camera"
              ? "bg-primary text-primary-foreground shadow-lg"
              : "text-muted-foreground hover:text-foreground"
          }`}
        >
          <Camera className="w-4 h-4" />
          Camera
        </button>
        <button
          onClick={() => switchMode("upload")}
          className={`flex items-center gap-2 px-5 py-2.5 rounded-md text-sm font-medium transition-all ${
            mode === "upload"
              ? "bg-primary text-primary-foreground shadow-lg"
              : "text-muted-foreground hover:text-foreground"
          }`}
        >
          <Upload className="w-4 h-4" />
          Upload
        </button>
      </div>

      {/* Scanner Area */}
      <div className="w-full max-w-lg">
        <div className="bg-card border border-border rounded-xl overflow-hidden scanner-glow">
          {/* Camera Mode */}
          {mode === "camera" && (
            <div className="relative">
              {!cameraActive && !result && (
                <div className="aspect-[4/3] flex flex-col items-center justify-center gap-4 bg-secondary/30">
                  <div className="w-20 h-20 rounded-2xl border-2 border-dashed border-primary/30 flex items-center justify-center">
                    <Camera className="w-8 h-8 text-primary/50" />
                  </div>
                  <button
                    onClick={startCamera}
                    className="px-6 py-3 bg-primary text-primary-foreground rounded-lg font-medium text-sm hover:opacity-90 transition-opacity"
                  >
                    Start Camera
                  </button>
                </div>
              )}
              <video
                ref={videoRef}
                className={`w-full aspect-[4/3] object-cover ${cameraActive ? "block" : "hidden"}`}
                playsInline
                muted
              />
              {cameraActive && (
                <div className="absolute inset-0 pointer-events-none">
                  {/* Scan line animation */}
                  <div className="absolute left-[15%] right-[15%] top-[15%] bottom-[15%]">
                    <div className="relative w-full h-full">
                      <div className="absolute left-0 right-0 h-1 scan-line animate-scan" />
                      {/* Corner brackets */}
                      <div className="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-primary" />
                      <div className="absolute top-0 right-0 w-6 h-6 border-t-2 border-r-2 border-primary" />
                      <div className="absolute bottom-0 left-0 w-6 h-6 border-b-2 border-l-2 border-primary" />
                      <div className="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 border-primary" />
                    </div>
                  </div>
                </div>
              )}
              {/* Canvas for camera result display */}
              <canvas
                ref={result && mode === "camera" ? canvasRef : undefined}
                className={result && mode === "camera" ? "w-full" : "hidden"}
              />
            </div>
          )}

          {/* Upload Mode */}
          {mode === "upload" && (
            <div>
              {!uploadedImage && !result && (
                <label className="aspect-[4/3] flex flex-col items-center justify-center gap-4 bg-secondary/30 cursor-pointer hover:bg-secondary/50 transition-colors">
                  <div className="w-20 h-20 rounded-2xl border-2 border-dashed border-primary/30 flex items-center justify-center pulse-border">
                    <Upload className="w-8 h-8 text-primary/50" />
                  </div>
                  <div className="text-center">
                    <p className="text-sm font-medium text-foreground">Click to upload image</p>
                    <p className="text-xs text-muted-foreground mt-1">PNG, JPG, WEBP supported</p>
                  </div>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    className="hidden"
                    onChange={handleFileUpload}
                  />
                </label>
              )}

              {/* Show uploaded image before scan, canvas after scan */}
              {uploadedImage && (
                <div className="relative">
                  <img
                    src={uploadedImage}
                    alt="Uploaded"
                    className={`w-full object-contain max-h-[400px] bg-secondary/20 ${result ? "hidden" : "block"}`}
                  />
                  <canvas
                    ref={canvasRef}
                    className={`w-full object-contain ${result ? "block" : "hidden"}`}
                  />
                  <button
                    onClick={resetAll}
                    className="absolute top-3 right-3 w-8 h-8 rounded-full bg-background/80 backdrop-blur flex items-center justify-center text-muted-foreground hover:text-foreground transition-colors"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Scan Button for Upload Mode */}
        {mode === "upload" && uploadedImage && !result && (
          <button
            onClick={scanUploadedImage}
            disabled={isScanning}
            className="w-full mt-4 py-3.5 bg-primary text-primary-foreground rounded-lg font-medium text-sm hover:opacity-90 transition-opacity disabled:opacity-50 flex items-center justify-center gap-2"
          >
            {isScanning ? (
              <>
                <div className="w-4 h-4 border-2 border-primary-foreground/30 border-t-primary-foreground rounded-full animate-spin" />
                Scanning...
              </>
            ) : (
              <>
                <ScanLine className="w-4 h-4" />
                Scan QR Code
              </>
            )}
          </button>
        )}

        {/* Error */}
        {error && (
          <div className="mt-4 p-4 bg-destructive/10 border border-destructive/20 rounded-lg flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-destructive shrink-0 mt-0.5" />
            <p className="text-sm text-destructive">{error}</p>
          </div>
        )}

        {/* Result */}
        {result && (
          <div className="mt-4 bg-card border border-primary/20 rounded-xl p-5 scanner-glow">
            <div className="flex items-center gap-2 mb-3">
              <CheckCircle2 className="w-5 h-5 text-primary" />
              <span className="text-sm font-semibold text-primary">QR Code Detected</span>
            </div>
            <div className="bg-secondary rounded-lg p-4 font-mono text-sm text-foreground break-all">
              {result.data}
            </div>
            <div className="flex gap-2 mt-4">
              <button
                onClick={copyResult}
                className="flex-1 py-2.5 bg-secondary text-secondary-foreground rounded-lg text-sm font-medium flex items-center justify-center gap-2 hover:bg-accent transition-colors"
              >
                {copied ? (
                  <>
                    <CheckCircle2 className="w-4 h-4" />
                    Copied!
                  </>
                ) : (
                  <>
                    <Copy className="w-4 h-4" />
                    Copy
                  </>
                )}
              </button>
              {isUrl(result.data) && (
                <a
                  href={result.data}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex-1 py-2.5 bg-primary text-primary-foreground rounded-lg text-sm font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-opacity"
                >
                  <ExternalLink className="w-4 h-4" />
                  Open Link
                </a>
              )}
            </div>
          </div>
        )}

        {/* Scan Again */}
        {(result || error) && (
          <button
            onClick={resetAll}
            className="w-full mt-3 py-3 bg-secondary text-secondary-foreground rounded-lg text-sm font-medium hover:bg-accent transition-colors"
          >
            Scan Another
          </button>
        )}
      </div>

      {/* Footer */}
      <p className="mt-12 text-xs text-muted-foreground font-mono">
        Built with jsQR â€¢ All processing happens locally
      </p>

      {/* Hidden canvas for camera mode processing */}
      {mode === "camera" && !result && (
        <canvas ref={canvasRef} className="hidden" />
      )}
    </div>
  );
};

export default Index;
